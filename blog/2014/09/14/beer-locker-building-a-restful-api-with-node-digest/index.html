
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Beer Locker: Building a RESTful API with Node - Digest - Scott Smith</title>
  <meta name="author" content="Scott Smith">

  
  <meta name="description" content="Many readers have asked questions about how to use different authentication strategies so I am going to continue this series and delve into many of those strategies. This article will explore the use &hellip;">
  <meta name="keywords" content="Node.js, JavaScript, REST, API, Express, Mongoose, MongoDB, Passport, OAuth, OAuth2, OAuth2orize, Tutorials">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://scottksmith.com/blog/2014/09/14/beer-locker-building-a-restful-api-with-node-digest">

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@scottksmith95" />
  <meta name="twitter:title" content="Beer Locker: Building a RESTful API with Node - Digest - Scott Smith" />
  <meta name="twitter:description" content="Many readers have asked questions about how to use different authentication strategies so I am going to continue this series and delve into many of those strategies. This article will explore the use &hellip;" />
  <meta name="twitter:url" content="http://scottksmith.com/blog/2014/09/14/beer-locker-building-a-restful-api-with-node-digest" />

  <meta property="og:title" content="Beer Locker: Building a RESTful API with Node - Digest - Scott Smith"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="Many readers have asked questions about how to use different authentication strategies so I am going to continue this series and delve into many of those strategies. This article will explore the use &hellip;"/>

  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">

  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style>
  #DegreedButton.degreed-28-full,.degreed-28-full {
    background-color: transparent !important;
    border: none !important;
    cursor: pointer !important;
    font-size: 0 !important;
    padding-bottom: 0 !important;
    padding-top: 0 !important;
    background-image: url(data:image/png;base64,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) !important;
    height: 28px !important;
    width: 162px !important;
  }
  </style>
  <link href="/atom.xml" rel="alternate" title="Scott Smith" type="application/atom+xml">

  <script src="//load.sumome.com/" data-sumo-site-id="0d857e605c25378eb99ef0880f3d471e6d4792fd62b3c1e378fa89057293706c" async="async"></script>
</head>

<body   >
  <header role="banner"><div class="logo">
  <img src="/images/logo.png" alt="Site Logo">
</div>
<hgroup>
  <h1><a href="/">Scott Smith</a></h1>
  <h2>
    <a href="/">Blog</a>
    <a href="/blog/categories/tutorials">Tutorials</a>
    <a href="/projects">Projects</a>
    <a href="/speaking">Speaking</a>
    <a href="/atom.xml" class="rss">RSS</a>
  </h2>
</hgroup>
</header>
  <div id="main">
    <div id="content">
      <div style="padding-top: 0;">
<article class="hentry" role="article">
  
  <header style="padding-top: 0;">
    
      <h1 class="entry-title">Beer Locker: Building a RESTful API With Node - Digest</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-14T13:28:00-07:00" pubdate data-updated="true">Sep 14<span>th</span>, 2014</time>
      </p>
    
    
      <button style="margin-top: 20px;" onclick="var e=document.createElement('script');e.setAttribute('charset','UTF-8');e.setAttribute('src','https://az287915.vo.msecnd.net/scripts/degreed/media/bookmarklet.js?id=1&v=' + Math.random()*99999999);document.getElementsByTagName('body')[0].appendChild(e)" title="+ Degreed" id="DegreedButton" class="degreed-28-full">+ Degreed</button>
    
  </header>


<div class="entry-content">
  <p>Welcome to part 5 of the Beer Locker series</p>

<ol>
<li><a href="/blog/2014/05/02/building-restful-apis-with-node/">Getting started</a></li>
<li><a href="/blog/2014/05/05/beer-locker-building-a-restful-api-with-node-crud/">CRUD</a></li>
<li><a href="/blog/2014/05/29/beer-locker-building-a-restful-api-with-node-passport/">Passport</a></li>
<li><a href="/blog/2014/07/02/beer-locker-building-a-restful-api-with-node-oauth2-server/">OAuth2 Server</a></li>
<li><a href="/blog/2014/09/14/beer-locker-building-a-restful-api-with-node-digest/">Digest</a></li>
<li><a href="/blog/2014/09/18/beer-locker-building-a-restful-api-with-node-username-and-password/">Username &amp; Password</a></li>
</ol>


<p>In our <a href="/blog/2014/07/02/beer-locker-building-a-restful-api-with-node-oauth2-server/">previous article</a> we ended wtih a functional API capable of creating user accounts, locking down API endpoints, only allowing access to a user&#8217;s own beer locker, and an OAuth2 server.</p>

<p>Many readers have asked questions about how to use different authentication strategies so I am going to continue this series and delve into many of those strategies.</p>

<p>This article will explore the use of Digest authentication instead of Basic.</p>

<!-- more -->


<h2>Digest</h2>

<p>Like the Basic scheme, Digest uses a username and password to authenticate a user. The benefit it provides over Basic is that it uses a challenge-response paradigm to avoid sending the password in the clear.</p>

<p>Here is how it works:</p>

<ol>
<li>Client sends an unauthenticated request to a server.</li>
<li>Server responds with a 401 &#8220;Unauthorized&#8221; reponse code along with a special code (called a nonce) and another string representing the authentication realm.</li>
<li>Client responds with the nonce and an encrypted version of the username, password and realm.</li>
<li>Server responds with a 200 OK and the response data if the authentication passes.</li>
</ol>


<h2>Update our Routes</h2>

<p>There is something odd going on with the way in which we defined our routes in the original tutorials. In most cases it isn&#8217;t an issue but it is for Digest auth. When we tell Express to use our router, we were prefixing it with <code>/api</code>. The problem is that Digest auth uses the URI as part of the scheme and the request object within Express is seeing it without the <code>/api</code> portion of the URI. This will cause authentication to fail. You will need to update <code>server.js</code> routes like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create endpoint handlers for /beers</span>
</span><span class='line'><span class="nx">router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;/api/beers&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">authController</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">,</span> <span class="nx">beerController</span><span class="p">.</span><span class="nx">postBeers</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">authController</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">,</span> <span class="nx">beerController</span><span class="p">.</span><span class="nx">getBeers</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create endpoint handlers for /beers/:beer_id</span>
</span><span class='line'><span class="nx">router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;/api/beers/:beer_id&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">authController</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">,</span> <span class="nx">beerController</span><span class="p">.</span><span class="nx">getBeer</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">authController</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">,</span> <span class="nx">beerController</span><span class="p">.</span><span class="nx">putBeer</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">authController</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">,</span> <span class="nx">beerController</span><span class="p">.</span><span class="nx">deleteBeer</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create endpoint handlers for /users</span>
</span><span class='line'><span class="nx">router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;/api/users&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">userController</span><span class="p">.</span><span class="nx">postUsers</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">authController</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">,</span> <span class="nx">userController</span><span class="p">.</span><span class="nx">getUsers</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create endpoint handlers for /clients</span>
</span><span class='line'><span class="nx">router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;/api/clients&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">authController</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">,</span> <span class="nx">clientController</span><span class="p">.</span><span class="nx">postClients</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">authController</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">,</span> <span class="nx">clientController</span><span class="p">.</span><span class="nx">getClients</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create endpoint handlers for oauth2 authorize</span>
</span><span class='line'><span class="nx">router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;/api/oauth2/authorize&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">authController</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">,</span> <span class="nx">oauth2Controller</span><span class="p">.</span><span class="nx">authorization</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">authController</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">,</span> <span class="nx">oauth2Controller</span><span class="p">.</span><span class="nx">decision</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create endpoint handlers for oauth2 token</span>
</span><span class='line'><span class="nx">router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;/api/oauth2/token&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">authController</span><span class="p">.</span><span class="nx">isClientAuthenticated</span><span class="p">,</span> <span class="nx">oauth2Controller</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Register all our routes</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Update our Auth Controller</h2>

<p>The first thing we need to do is update our Auth Controller. Open <code>controllers/auth.js</code> and implement the Digest strategy as follows. You can leave the Basic auth strategy implementation if you want. We will be updating the <code>isAuthenticated</code> to use Digest instead of Basic.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Load required packages</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">DigestStrategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport-http&#39;</span><span class="p">).</span><span class="nx">DigestStrategy</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">DigestStrategy</span><span class="p">(</span>
</span><span class='line'>  <span class="p">{</span> <span class="nx">qop</span><span class="o">:</span> <span class="s1">&#39;auth&#39;</span> <span class="p">},</span>
</span><span class='line'>  <span class="kd">function</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="nx">username</span> <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// No user found with that username</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Success</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// validate nonces as necessary</span>
</span><span class='line'>    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">isAuthenticated</span> <span class="o">=</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">([</span><span class="s1">&#39;digest&#39;</span><span class="p">,</span> <span class="s1">&#39;bearer&#39;</span><span class="p">],</span> <span class="p">{</span> <span class="nx">session</span> <span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have done 3 main things here.</p>

<p>First, we required the DigestStrategy provided by the <code>passport-http</code> module.</p>

<p>Second, we told Passport to use DigestStrategy. Inside this we told it to use <code>qop: 'auth'</code> which is quality of protection along with two anonymous functions. The first function does our verification of the user and if success we call the callback and supply the user along with their password. The second anonymous function can be used to protect against replay attacks. Nonces should be validated to make sure they are not used again. You can do this by storing issued nonces and removing them as they are used. This will increase the security of your authentication.</p>

<p>Third, we updated <code>isAuthenticated</code> to use digest instead of basic.</p>

<h2>Remove hashing of passwords :(</h2>

<p>This is the part of using Digest and more specifically the implementation provided by the <code>passport-http</code> module that I like the least. You cannot store the password as a hash. You need to get to the original password in order for the authentication to work. At the very least you will want to encrypt the password. I highly advise you analyze this type of approach for your application. If you must use Digest, you may want to consider implementing your own Digest strategy or updating the existing one where you don&#8217;t pass in the password in the success callback. You could instead pass in the MD5 hash of the <code>username:realm:password</code> which you have pre calculated and stored.</p>

<p>So on to the very unsafe update to our User model. Again, for the tutorial we are going to store the password in plain text. You NEVER want to do this in a real situation. You will want to look into cryptography modules such as <code>crypto</code> to do this.</p>

<p>Open up <code>models/user.js</code> and update it to look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Load required packages</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Define our user schema</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">UserSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">username</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">unique</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">password</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Export the Mongoose model</span>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="nx">UserSchema</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Testing it out</h2>

<p>Fire up your trusted tool such as Postman and create a new user as the old ones will have hashed passwords which will not work.</p>

<p>I found using Postman to test Digest a bit unfriendly so I opted instead for curl.</p>

<p>Here is a command you can use to test your API using Digest:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='tcsh'><span class='line'>curl -v --user smith:smith --digest http://127.0.0.1:3000/api/users
</span></code></pre></td></tr></table></div></figure>


<p>Just change the username:password to whatever you used. This command is great in curl because it will issue the intial unauthenticated request, process the reponse along with the nonce, qop, realm, etc, and finally issue another authenticated request.</p>

<p>Here is what my test looked like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='tcsh'><span class='line'>curl -v --user smith:smith --digest http://127.0.0.1:3000/api/users
</span><span class='line'>
</span><span class='line'>* About to connect<span class="o">()</span> to 127.0.0.1 port 3000 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>*   Trying 127.0.0.1...
</span><span class='line'>* Adding handle: conn: 0x7ffb71804000
</span><span class='line'>* Adding handle: send: 0
</span><span class='line'>* Adding handle: recv: 0
</span><span class='line'>* Curl_addHandleToPipeline: length: 1
</span><span class='line'>* - Conn 0 <span class="o">(</span>0x7ffb71804000<span class="o">)</span> send_pipe: 1, recv_pipe: 0
</span><span class='line'>* Connected to 127.0.0.1 <span class="o">(</span>127.0.0.1<span class="o">)</span> port 3000 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>* Server auth using Digest with user <span class="s1">&#39;smith&#39;</span>
</span><span class='line'>&gt; GET /api/users HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.30.0
</span><span class='line'>&gt; Host: 127.0.0.1:3000
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt;
</span><span class='line'>&lt; HTTP/1.1 401 Unauthorized
</span><span class='line'>&lt; X-Powered-By: Express
</span><span class='line'>&lt; WWW-Authenticate: Digest <span class="nv">realm</span><span class="o">=</span><span class="s2">&quot;Users&quot;</span>, <span class="nv">nonce</span><span class="o">=</span><span class="s2">&quot;x9hR8HiV9szqnvzUU7DsS5ekfq4xNM2p&quot;</span>, <span class="nv">algorithm</span><span class="o">=</span>MD5, <span class="nv">qop</span><span class="o">=</span><span class="s2">&quot;auth&quot;</span>
</span><span class='line'>&lt; WWW-Authenticate: Bearer <span class="nv">realm</span><span class="o">=</span><span class="s2">&quot;Users&quot;</span>
</span><span class='line'>&lt; Date: Sun, 14 Sep 2014 23:05:02 GMT
</span><span class='line'>&lt; Connection: keep-alive
</span><span class='line'>&lt; Transfer-Encoding: chunked
</span><span class='line'>&lt;
</span><span class='line'>* Ignoring the response-body
</span><span class='line'>* Connection <span class="c">#0 to host 127.0.0.1 left intact</span>
</span><span class='line'>* Issue another request to this URL: <span class="s1">&#39;http://127.0.0.1:3000/api/users&#39;</span>
</span><span class='line'>* Found bundle for host 127.0.0.1: 0x7ffb71415150
</span><span class='line'>* Re-using existing connection! <span class="o">(</span><span class="c">#0) with host 127.0.0.1</span>
</span><span class='line'>* Connected to 127.0.0.1 <span class="o">(</span>127.0.0.1<span class="o">)</span> port 3000 <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>* Adding handle: conn: 0x7ffb71804000
</span><span class='line'>* Adding handle: send: 0
</span><span class='line'>* Adding handle: recv: 0
</span><span class='line'>* Curl_addHandleToPipeline: length: 1
</span><span class='line'>* - Conn 0 <span class="o">(</span>0x7ffb71804000<span class="o">)</span> send_pipe: 1, recv_pipe: 0
</span><span class='line'>* Server auth using Digest with user <span class="s1">&#39;smith&#39;</span>
</span><span class='line'>&gt; GET /api/users HTTP/1.1
</span><span class='line'>&gt; Authorization: Digest <span class="nv">username</span><span class="o">=</span><span class="s2">&quot;smith&quot;</span>, <span class="nv">realm</span><span class="o">=</span><span class="s2">&quot;Users&quot;</span>, <span class="nv">nonce</span><span class="o">=</span><span class="s2">&quot;x9hR8HiV9szqnvzUU7DsS5ekfq4xNM2p&quot;</span>, <span class="nv">uri</span><span class="o">=</span><span class="s2">&quot;/api/users&quot;</span>, <span class="nv">cnonce</span><span class="o">=</span><span class="s2">&quot;ICAgICAgICAgICAgICAgICAgICAgIDE0MTEzMjk4NDQ=&quot;</span>, <span class="nv">nc</span><span class="o">=</span>00000001, <span class="nv">qop</span><span class="o">=</span>auth, <span class="nv">response</span><span class="o">=</span><span class="s2">&quot;a9b8ab69c3a44c253a7834bdfe45b26d&quot;</span>, <span class="nv">algorithm</span><span class="o">=</span><span class="s2">&quot;MD5&quot;</span>
</span><span class='line'>&gt; User-Agent: curl/7.30.0
</span><span class='line'>&gt; Host: 127.0.0.1:3000
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt;
</span><span class='line'>&lt; HTTP/1.1 200 OK
</span><span class='line'>&lt; X-Powered-By: Express
</span><span class='line'>&lt; Content-Type: application/json
</span><span class='line'>&lt; Content-Length: 354
</span><span class='line'>&lt; ETag: <span class="s2">&quot;-1301455500&quot;</span>
</span><span class='line'>&lt; Date: Sun, 14 Sep 2014 23:05:02 GMT
</span><span class='line'>&lt; Connection: keep-alive
</span><span class='line'>&lt;
</span><span class='line'>* Connection <span class="c">#0 to host 127.0.0.1 left intact</span>
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Wrap up</h2>

<p>You now have the tools needed to implement Digest authentication.</p>

<p>I still strongly caution against the use as it currently stands. I highly dislike and advise against storing passwords encrypted. It is only slightly better than plain text since it is encrypted, but it is only one step away from becoming plain text. The best is to implement your own Digest strategy so you can store your passwords in a way that they can be hashed.</p>

<p>If you have thoughts on this, please share them in the comments section.</p>

<p>I have a lot more tutorials coming so be sure to <a href="http://scottksmith.com/atom.xml">subscribe to my RSS feed</a> or <a href="https://twitter.com/scottksmith95">follow me on Twitter</a>. Also, if there are certain topics you would like me to write on, feel free to leave comments and let me know.</p>

<p>Source code for this part can be found <a href="https://github.com/scottksmith95/beerlocker/tree/master/beerlocker-5">here on GitHub</a>.</p>

</div>


  <button onclick="var e=document.createElement('script');e.setAttribute('charset','UTF-8');e.setAttribute('src','https://az287915.vo.msecnd.net/scripts/degreed/media/bookmarklet.js?id=1&v=' + Math.random()*99999999);document.getElementsByTagName('body')[0].appendChild(e)
  " title="+ Degreed" id="DegreedButton" class="degreed-28-full">+ Degreed</button>
  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Scott Smith</span></span>

      








  


<time datetime="2014-09-14T13:28:00-07:00" pubdate data-updated="true">Sep 14<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/beer/'>Beer</a>, <a class='category' href='/blog/categories/javascript/'>JavaScript</a>, <a class='category' href='/blog/categories/node-dot-js/'>Node.js</a>, <a class='category' href='/blog/categories/tutorials/'>Tutorials</a>
  
</span>


    </p>
    
      <!-- <div class="sharing">
  <h4>Share On:</h4>
  <a href="https://twitter.com/intent/tweet?text=Beer Locker: Building a RESTful API with Node - Digest&url=http://scottksmith.com/blog/2014/09/14/beer-locker-building-a-restful-api-with-node-digest/&via=scottksmith95" target="_blank">
    <img src="/images/icons/twitter/twitter-128.png" alt="Share on Twitter" class="twitter">
  </a>
  <a href="https://plus.google.com/share?url=http://scottksmith.com/blog/2014/09/14/beer-locker-building-a-restful-api-with-node-digest/" target="_blank">
    <img src="/images/icons/googleplus/googleplus-128.png" alt="Share on Google+" class="googleplus">
  </a>
  <a href="https://www.facebook.com/sharer/sharer.php?u=http://scottksmith.com/blog/2014/09/14/beer-locker-building-a-restful-api-with-node-digest/" target="_blank">
    <img src="/images/icons/facebook/facebook-128.png" alt="Share on Facebook" class="facebook">
  </a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&title=Beer Locker: Building a RESTful API with Node - Digest&url=http://scottksmith.com/blog/2014/09/14/beer-locker-building-a-restful-api-with-node-digest/" target="_blank">
    <img src="/images/icons/linkedin/linkedin-128.png" alt="Share on LinkedIn" class="linkedin">
  </a>
  <a href="mailto:?body=http://scottksmith.com/blog/2014/09/14/beer-locker-building-a-restful-api-with-node-digest/&subject=Beer Locker: Building a RESTful API with Node - Digest">
    <img src="/images/icons/email/email-128.png" alt="Share via Email" class="email">
  </a>
</div> -->
    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/09/04/simple-steps-to-secure-your-express-node-application/" title="Previous Post: 4 Simple Steps To Secure Your Express Node Application">&laquo; 4 Simple Steps To Secure Your Express Node Application</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/09/18/beer-locker-building-a-restful-api-with-node-username-and-password/" title="Next Post: Beer Locker: Building a RESTful API with Node - Username &amp; Password">Beer Locker: Building a RESTful API with Node - Username &amp; Password &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section id="links">
  <div>
    <a href="https://twitter.com/scottksmith95" target="_blank">
      <img src="/images/icons/twitter/twitter-128.png" class="twitter" alt="Scott Smith on Twitter">
    </a>
  </div>
  <div>
    <a href="https://github.com/scottksmith95" target="_blank">
      <img src="/images/icons/github/github-128.png" class="github" alt="Scott Smith on GitHub">
    </a>
  </div>
  <div>
    <a href="https://www.linkedin.com/profile/view?id=15073485" target="_blank">
      <img src="/images/icons/linkedin/linkedin-128.png" class="linkedin" alt="Scott Smith on LinkedIn">
    </a>
  </div>
  <div>
    <a href="mailto:scottksmith95@gmail.com">
      <img src="/images/icons/email/email-128.png" class="email" alt="Scott Smith's Email">
    </a>
  </div>
  <div>
    <a href="/atom.xml">
      <img src="/images/icons/rss/rss-128.png" class="rss" "Site RSS Feed">
    </a>
  </div>
</section>

<section id="about">
  <p>Software developer, learner, writer, & speaker.</p>
  <p>Currently jailbreaking the degree at Degreed and promoting lifelong learning.</p>
  <p>Past projects incude coderbits which was sold to Appirio in 2014 and Favatron.</p>
</section><section id="newsletter">
  <img src="/images/icons/email/email-128.png">
  <h2>Get My Latest Articles</h2>
  <form action="//favatron.us5.list-manage.com/subscribe/post?u=e8909f2779b99d9865361d28e&amp;id=1d7e590a16" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="Email address" required>
    <div style="position: absolute; left: -5000px;">
      <input type="text" name="b_e8909f2779b99d9865361d28e_1d7e590a16" tabindex="-1" value="">
    </div>
    <div class="clear">
      <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
    </div>
  </form>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><span style="text-align: center">
  Copyright &copy; 2017 <a rel="author" href="https://plus.google.com/107452035819962532888?rel=author">Scott Smith</a>
</span>

<div class="icons">
  <span>
    <a href="https://twitter.com/scottksmith95">
      <img src="/images/icons/twitter/twitter-128.png" class="twitter">
    </a>
  </span>
  <span>
    <a href="https://github.com/scottksmith95">
      <img src="/images/icons/github/github-128.png" class="github">
    </a>
  </span>
  <span>
    <a href="https://www.linkedin.com/profile/view?id=15073485">
      <img src="/images/icons/linkedin/linkedin-128.png" class="linkedin">
    </a>
  </span>
  <span>
    <a href="mailto:scottksmith95@gmail.com">
      <img src="/images/icons/email/email-128.png" class="email">
    </a>
  </span>
  <span>
    <a href="/atom.xml">
      <img src="/images/icons/rss/rss-128.png" class="rss">
    </a>
  </span>
</div></footer>
  

<script type="text/javascript">
      var disqus_shortname = 'scottksmithblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://scottksmith.com/blog/2014/09/14/beer-locker-building-a-restful-api-with-node-digest/';
        var disqus_url = 'http://scottksmith.com/blog/2014/09/14/beer-locker-building-a-restful-api-with-node-digest/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


<script src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>
<script src="/javascripts/octopress.js" type="text/javascript"></script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-40783302-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

</body>
</html>